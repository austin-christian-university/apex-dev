#!/usr/bin/env node

/**
 * Populi API Documentation Extractor
 * 
 * This script extracts the complete documentation from the Populi API website
 * and saves it to a markdown file for easy reference.
 * 
 * Usage:
 *   node tools/extract-populi-docs.js
 * 
 * Requirements:
 *   npm install puppeteer
 */

const puppeteer = require('puppeteer');
const fs = require('fs').promises;
const path = require('path');

const POPULI_API_URL = 'https://populi.co/api/#introduction';
const OUTPUT_FILE = path.join(__dirname, '../.cursor/docs/populi_api.md');

async function extractPopuliDocs() {
  console.log('🚀 Starting Populi API documentation extraction...');
  
  const browser = await puppeteer.launch({
    headless: 'new',
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  try {
    const page = await browser.newPage();
    
    // Set a reasonable viewport
    await page.setViewport({ width: 1200, height: 800 });
    
    console.log(`📄 Navigating to ${POPULI_API_URL}...`);
    await page.goto(POPULI_API_URL, { 
      waitUntil: 'networkidle2',
      timeout: 30000 
    });

    // Wait for the content to load
    await page.waitForSelector('body', { timeout: 10000 });
    
    console.log('🔍 Extracting content...');
    
    // Extract the main content
    const content = await page.evaluate(() => {
      // Remove navigation, headers, footers, and other non-content elements
      const elementsToRemove = [
        'nav',
        'header',
        'footer',
        '.sidebar',
        '.navigation',
        '.menu',
        '.header',
        '.footer',
        'script',
        'style'
      ];
      
      elementsToRemove.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => el.remove());
      });

      // Get the main content
      const mainContent = document.querySelector('main') || 
                         document.querySelector('.content') || 
                         document.querySelector('#content') || 
                         document.body;

      return {
        title: document.title,
        url: window.location.href,
        content: mainContent.innerText || mainContent.textContent,
        html: mainContent.innerHTML
      };
    });

    // Format the content as markdown
    const markdown = formatAsMarkdown(content);
    
    // Save to file
    await fs.writeFile(OUTPUT_FILE, markdown, 'utf8');
    
    console.log(`✅ Documentation extracted successfully to ${OUTPUT_FILE}`);
    console.log(`📊 Extracted ${content.content.length} characters of content`);
    
  } catch (error) {
    console.error('❌ Error extracting documentation:', error.message);
    throw error;
  } finally {
    await browser.close();
  }
}

function formatAsMarkdown(content) {
  const timestamp = new Date().toISOString();
  
  return `# Populi API Documentation

This file contains the extracted documentation from the Populi API website.

## Source Information
- **URL**: ${content.url}
- **Title**: ${content.title}
- **Extracted**: ${timestamp}
- **Extraction Method**: Puppeteer web scraping

## Raw Content

\`\`\`
${content.content}
\`\`\`

## HTML Content (for reference)

\`\`\`html
${content.html}
\`\`\`

---
*This file was automatically generated by the extract-populi-docs.js script.*
`;
}

// Run the extraction if this script is executed directly
if (require.main === module) {
  extractPopuliDocs()
    .then(() => {
      console.log('🎉 Extraction completed successfully!');
      process.exit(0);
    })
    .catch((error) => {
      console.error('💥 Extraction failed:', error);
      process.exit(1);
    });
}

module.exports = { extractPopuliDocs }; 